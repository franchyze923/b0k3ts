<mat-card class="om-card">
  <mat-card-header>
    <mat-card-title>Object Manager</mat-card-title>
    <mat-card-subtitle>
      Manage bucket objects: list, upload, delete, move
      <mat-chip-set class="chips" aria-label="Object stats">
        <mat-chip>{{ objectCount() }} objects</mat-chip>
        <mat-chip>Bucket: {{ selectedBucket() }}</mat-chip>
      </mat-chip-set>
    </mat-card-subtitle>
  </mat-card-header>
  <br />

  <mat-card-content>
    <div class="toolbar-row">
      <mat-form-field appearance="outline" class="bucket-select">
        <mat-label>Bucket</mat-label>
        <mat-select [ngModel]="selectedBucket()" (ngModelChange)="onBucketChange($event)">
          @for (b of buckets(); track b) {
            <mat-option [value]="b">{{ b }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Upload prefix</mat-label>
        <input
          matInput
          placeholder="e.g. reports/2026/ (optional)"
          [ngModel]="uploadPrefix()"
          (ngModelChange)="uploadPrefix.set($event)"
        />
      </mat-form-field>

      <button mat-stroked-button type="button" (click)="refresh()">
        <mat-icon aria-hidden="true">refresh</mat-icon>
        Refresh
      </button>

      <input
        #fileInput
        type="file"
        multiple
        hidden
        (change)="onUploadFiles(fileInput.files); fileInput.value = ''"
      />

      <button
        mat-flat-button
        color="primary"
        type="button"
        (click)="fileInput.click()"
        [disabled]="isUploading()"
      >
        <mat-icon aria-hidden="true">upload</mat-icon>
        Upload
      </button>
    </div>

    @if (uploadTasks().length > 0) {
      <div class="upload-panel" aria-label="Upload progress">
        <div class="upload-panel-header">
          <div class="upload-title">Uploads</div>

          <div class="upload-actions">
            <button mat-stroked-button type="button" (click)="clearCompletedUploads()">
              Clear completed
            </button>
            <button mat-stroked-button type="button" (click)="clearAllUploads()">Clear all</button>
          </div>
        </div>

        <div class="upload-list">
          @for (t of uploadTasks(); track t.id) {
            <div class="upload-item" [class.is-error]="t.status === 'error'">
              <div class="upload-topline">
                <div class="upload-name">{{ t.fileName }}</div>
                <div class="upload-meta">
                  @if (t.status === 'uploading') {
                    <span>
                      {{ t.percent.toFixed(1) }}% · {{ formatBytes(t.uploadedBytes) }} /
                      {{ formatBytes(t.totalBytes) }}
                      @if (t.partNumber && t.partCount) {
                        · part {{ t.partNumber }}/{{ t.partCount }}
                      }
                    </span>
                  } @else if (t.status === 'done') {
                    <span>Done · {{ formatBytes(t.totalBytes) }}</span>
                  } @else if (t.status === 'queued') {
                    <span>Queued</span>
                  } @else {
                    <span>Error</span>
                  }
                </div>
              </div>

              <mat-progress-bar
                mode="determinate"
                [value]="t.percent"
                [color]="t.status === 'error' ? 'warn' : 'primary'"
              ></mat-progress-bar>

              @if (t.status === 'error' && t.errorMessage) {
                <div class="upload-error">{{ t.errorMessage }}</div>
              }
            </div>
          }
        </div>
      </div>
    }

    <div class="explorer">
      <!-- Right: details view -->
      <div class="pane pane-right" aria-label="Files">
        <div class="address-bar">
          <button
            mat-icon-button
            type="button"
            (click)="goUp()"
            [disabled]="!currentDir()"
            aria-label="Up"
          >
            <mat-icon aria-hidden="true">arrow_upward</mat-icon>
          </button>

          <button mat-button type="button" (click)="goToDir('')">This bucket</button>

          @for (c of breadcrumbs(); track c.path) {
            <span class="crumb-sep">/</span>
            <button mat-button type="button" (click)="goToDir(c.path)">{{ c.label }}</button>
          }
        </div>

        <div class="details-wrap">
          <table
            mat-table
            [dataSource]="explorerRows()"
            class="details-table"
            aria-label="Folder contents"
          >
            <!-- Name -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let row" (dblclick)="onRowActivate(row)" class="name-cell">
                <mat-icon aria-hidden="true" class="row-icon">
                  {{ row.kind === 'dir' ? 'folder' : 'description' }}
                </mat-icon>
                <span class="row-name">{{ row.name }}</span>
              </td>
            </ng-container>

            <!-- Size -->
            <ng-container matColumnDef="size">
              <th mat-header-cell *matHeaderCellDef class="col-size">Size</th>
              <td mat-cell *matCellDef="let row" class="col-size">
                @if (row.kind === 'file') {
                  {{ formatBytes(row.obj.sizeBytes) }}
                } @else {
                  —
                }
              </td>
            </ng-container>

            <!-- Type -->
            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let row">
                {{ fileTypeLabel(row) }}
              </td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="col-actions"></th>
              <td mat-cell *matCellDef="let row" class="col-actions">
                @if (row.kind === 'file') {
                  <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="File actions">
                    <mat-icon aria-hidden="true">more_vert</mat-icon>
                  </button>

                  <mat-menu #menu="matMenu">
                    <button mat-menu-item type="button" (click)="downloadObject(row.obj)">
                      <mat-icon aria-hidden="true">download</mat-icon>
                      <span>Download</span>
                    </button>

                    <button mat-menu-item type="button" (click)="moveObject(row.obj)">
                      <mat-icon aria-hidden="true">drive_file_move</mat-icon>
                      <span>Move</span>
                    </button>

                    <button mat-menu-item type="button" (click)="deleteObject(row.obj)">
                      <mat-icon aria-hidden="true">delete</mat-icon>
                      <span>Delete</span>
                    </button>
                  </mat-menu>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>
      </div>
    </div>
  </mat-card-content>
</mat-card>
