<mat-card class="settings-card">
  <mat-card-header>
    <mat-card-title>Local Users</mat-card-title>
    <mat-card-subtitle>
      Create, disable, delete, and reset passwords for local users.
    </mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="grid">
      <mat-form-field appearance="outline">
        <mat-label>Username</mat-label>
        <input
          matInput
          [ngModel]="draft().username"
          (ngModelChange)="updateDraft({ username: $event })"
          placeholder="alice"
          [disabled]="loading() || working()"
        />
      </mat-form-field>

      <div class="inline-actions">
        <button mat-stroked-button type="button" (click)="lookup()" [disabled]="!canLookup()">
          <mat-icon aria-hidden="true">search</mat-icon>
          <span>{{ loading() ? 'Looking…' : 'Lookup' }}</span>
        </button>

        <button mat-stroked-button type="button" (click)="checkExists()" [disabled]="!canLookup()">
          <mat-icon aria-hidden="true">help_outline</mat-icon>
          <span>Exists?</span>
        </button>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Password</mat-label>
        <input
          matInput
          type="password"
          [ngModel]="draft().password"
          (ngModelChange)="updateDraft({ password: $event })"
          placeholder="••••••••"
          [disabled]="loading() || working()"
        />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Confirm password</mat-label>
        <input
          matInput
          type="password"
          [ngModel]="draft().password2"
          (ngModelChange)="updateDraft({ password2: $event })"
          placeholder="••••••••"
          [disabled]="loading() || working()"
        />
      </mat-form-field>

      <mat-slide-toggle
        [ngModel]="draft().administrator"
        (ngModelChange)="updateDraft({ administrator: $event })"
        [disabled]="loading() || working()"
      >
        Administrator
      </mat-slide-toggle>
    </div>

    <div class="actions-row">
      <button
        mat-flat-button
        color="primary"
        type="button"
        (click)="createUser()"
        [disabled]="!canCreate()"
      >
        <mat-icon aria-hidden="true">person_add</mat-icon>
        <span>{{ working() ? 'Working…' : 'Create user' }}</span>
      </button>

      <button
        mat-stroked-button
        type="button"
        (click)="resetPassword(draft().username.trim())"
        [disabled]="!canResetPassword()"
      >
        <mat-icon aria-hidden="true">key</mat-icon>
        <span>Reset password</span>
      </button>

      <span class="spacer"></span>

      <button mat-button type="button" (click)="clearForm()" [disabled]="loading() || working()">
        <mat-icon aria-hidden="true">refresh</mat-icon>
        <span>Clear</span>
      </button>
    </div>

    @if (error()) {
      <div class="error-row">
        <mat-icon aria-hidden="true">error_outline</mat-icon>
        <span>{{ error() }}</span>
      </div>
    }

    <div class="table-wrap">
      <table mat-table [dataSource]="users()" class="mat-elevation-z0">
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef>Username</th>
          <td mat-cell *matCellDef="let row">
            <button class="linklike" type="button" (click)="selectRow(row)">
              <code>{{ row.username }}</code>
            </button>
            @if (row.email) {
              <div class="subtle">{{ row.email }}</div>
            }
            @if (row.groups?.length) {
              <div class="subtle">Groups: {{ row.groups.join(', ') }}</div>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="administrator">
          <th mat-header-cell *matHeaderCellDef>Admin</th>
          <td mat-cell *matCellDef="let row">
            {{ row.administrator ? 'Yes' : 'No' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="disabled">
          <th mat-header-cell *matHeaderCellDef>Disabled</th>
          <td mat-cell *matCellDef="let row">
            {{ row.disabled ? 'Yes' : 'No' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let row" class="row-actions">
            <button
              mat-icon-button
              type="button"
              aria-label="Lookup user"
              (click)="selectRow(row); lookup()"
              [disabled]="loading() || working()"
            >
              <mat-icon aria-hidden="true">search</mat-icon>
            </button>

            <button
              mat-icon-button
              type="button"
              [attr.aria-label]="row.disabled ? 'Enable user' : 'Disable user'"
              (click)="setDisabled(row.username, !row.disabled)"
              [disabled]="loading() || working()"
            >
              <mat-icon aria-hidden="true">{{ row.disabled ? 'check_circle' : 'block' }}</mat-icon>
            </button>

            <button
              mat-icon-button
              type="button"
              aria-label="Delete user"
              (click)="delete(row.username)"
              [disabled]="loading() || working()"
            >
              <mat-icon aria-hidden="true">delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let _; columns: displayedColumns"></tr>
      </table>

      @if (!users().length) {
        <div class="empty">No users loaded yet. Lookup a username to populate the table.</div>
      }
    </div>
  </mat-card-content>
</mat-card>
